<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background-color: black;
      color: white;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    svg {
      background-color: #333;
    }
    .tooltip {
      position: absolute;
      background-color: white;
      color: black;
      padding: 5px;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none;
      visibility: hidden;
    }
    h1 {
      margin-top: 20px;
    }
    .slider-container {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }
    .slider {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Interactive Global Radar Chart</h1>
  <div id="map-container">
    <svg id="map" width="800" height="500"></svg>
    <svg id="radarChart" width="500" height="500"></svg>
  </div>
  <div class="slider-container">
    <label for="yearSlider">Year:</label>
    <input type="range" id="yearSlider" class="slider" min="2000" max="2023" step="1" value="2000">
    <span id="yearDisplay">2000</span>
  </div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const parameters = ["Renewable", "LifeExpectancy", "Healthcare", "CO2", "CostOfLiving", "AverageIncome"];
    const angleSlice = (Math.PI * 2) / parameters.length;
    const radarWidth = 500, radarHeight = 500, radius = Math.min(radarWidth, radarHeight) / 2 - 50;
    const centerX = radarWidth / 2, centerY = radarHeight / 2;

    const mapSvg = d3.select("#map");
    const radarSvg = d3.select("#radarChart");
    const tooltip = d3.select("#tooltip");
    const yearSlider = d3.select("#yearSlider");
    const yearDisplay = d3.select("#yearDisplay");

    let scales = {};
    let globalData = {};
    let currentYear = "2000";
    let selectedCountry = null; 
    let countries = new Set(); 

    const radarLine = d3.lineRadial()
        .angle((d, i) => i * angleSlice)
        .radius(d => scales[d.parameter](d.value))
        .curve(d3.curveLinearClosed);

    // Load data and GeoJSON
    Promise.all([
        d3.json("./data/global.geo.json"),
        d3.csv("./data/Combined_cleaned_reduced.csv"),
        d3.csv("./data/regional_cost_of_living.csv")
    ]).then(([geoData, combinedData, costOfLiving]) => {
        processData(combinedData, costOfLiving);
        drawMap(geoData);
        updateRadar({}); 
    });

    function processData(combinedData, costOfLiving) {
        combinedData.forEach(d => {
            const country = d.Country;
            const year = d.Year;
            if (!globalData[country]) globalData[country] = {};
            globalData[country][year] = {
                Renewable: +d.TotalRenewableEnergy || 0,
                LifeExpectancy: +d.Life_Expect || 0,
                Healthcare: +d.Health_Expenditure || 0,
                CO2: +d.CO2 || 0,
                CostOfLiving: +d.Cost_of_Living || 0,
                AverageIncome: +d.Average_Monthly_Income || 0
            };
            countries.add(country);
        });
    }

    function drawMap(geoData) {
      const projection = d3.geoMercator().fitSize([800, 500], geoData);
      const path = d3.geoPath().projection(projection);
  
      mapSvg.selectAll("path")
          .data(geoData.features)
          .join("path")
          .attr("d", path)
          .attr("fill", d => countries.has(d.properties.name) ? "#c7f5ff" : "#444")
          .attr("stroke", "white")
          .attr("class", "country")
          .on("mouseover", (event, d) => {
              const country = d.properties.name;
              tooltip.style("visibility", "visible").text(country);
          })
          .on("mousemove", event => {
              tooltip.style("top", (event.pageY - 20) + "px")
                     .style("left", (event.pageX + 10) + "px");
          })
          .on("mouseout", () => {
              tooltip.style("visibility", "hidden");
          })
          .on("click", (event, d) => {
              selectedCountry = d.properties.name;
              updateRadarCountry(selectedCountry);
  
              mapSvg.selectAll(".country")
                  .attr("fill", d => {
                      if (d.properties.name === selectedCountry) {
                          return "#ffa500"; // orange highlighting
                      }
                      return countries.has(d.properties.name) ? "#c7f5ff" : "#444";
                  });
          });
  }

    function updateRadarCountry(country) {
        if (!country || !globalData[country] || !globalData[country][currentYear]) {
            console.warn("No data for:", country, "Year:", currentYear);
            updateRadar({});
            return;
        }
        updateRadar(globalData[country][currentYear]);
    }

    function updateRadar(data) {
      radarSvg.selectAll("*").remove();  
      parameters.forEach(param => {
          scales[param] = d3.scaleLinear()
              .domain([
                  0,
                  d3.max(
                      Object.values(globalData).flatMap(countryData =>
                          Object.values(countryData).map(yearData => yearData[param] || 0)
                      )
                  )
              ])
              .range([0, radius]);
  
          console.log(`Scale for ${param}:`, scales[param].domain());
      });
  
      const radarGroup = radarSvg.append("g").attr("transform", `translate(${centerX}, ${centerY})`);
  
      for (let i = 1; i <= 5; i++) {
          radarGroup.append("circle")
              .attr("r", (radius / 5) * i)
              .style("fill", "none")
              .style("stroke", "#aaa");
      }
  
      parameters.forEach((param, i) => {
          const x = radius * Math.cos(angleSlice * i - Math.PI / 2);
          const y = radius * Math.sin(angleSlice * i - Math.PI / 2);
  
          radarGroup.append("line")
              .attr("x1", 0)
              .attr("y1", 0)
              .attr("x2", x)
              .attr("y2", y)
              .style("stroke", "gray");
  
          radarGroup.append("text")
              .attr("x", x * 1.1)
              .attr("y", y * 1.1)
              .style("text-anchor", "middle")
              .style("fill", "white")
              .text(param);
      });
  
      const formattedData = parameters.map(param => ({
          parameter: param,
          value: data[param] || 0 
      }));
  
      console.log("Formatted Data for Radar Chart:", formattedData);
  
      radarGroup.append("path")
          .datum(formattedData)
          .attr("d", radarLine)
          .style("fill", "lightblue")
          .style("stroke", "blue")
          .style("opacity", 0.7);
  }

    yearSlider.on("input", function () {
        currentYear = this.value;
        yearDisplay.text(currentYear);
        if (selectedCountry) {
            updateRadarCountry(selectedCountry);
        }
    });
  </script>


</body>
</html>
