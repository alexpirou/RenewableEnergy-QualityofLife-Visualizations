<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
    }

    #graph-description {
      margin-left: 200px;
    }

    h2 {
      margin-left: 350px;
    }

    .line {
      fill: none;
      stroke-width: 4px;
    }

    .axis-label {
      font-size: 14px;
      font-weight: bold;
    }

    .tooltip {
      position: absolute;
      text-align: center;
      background: white;
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      display: none;
    }

    .subheader {
      font-size:16px;
    }
    .legend {
      font-size: 16px;
    }


    .y-axis-energy .tick text {
      fill: #53C44F;
      font-size: 14px;
    }

    .y-axis-life .tick text {
      fill: #5F9DD4;
      font-size: 14px;
    }

    .y-axis-co2 .tick text {
      fill:#EC5042;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="graph-description">
    <h2>Time Series Line Graph</h2>
    <p class= "subheader">Analyzing the Relationship Between Life Expectancy, CO2 Emissions, and Global Annual Renewable Energy
      Production (2000–2020)</p>
  </div>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>
  <script>
    const drawMultiLineChart = async () => {
      // Load data
      const [renewableEnergyData, lifeExpectancyData] = await Promise.all([
        d3.csv("global_renewable_energy_production.csv"),
        d3.csv("life_expectancy.csv"),
      ]);

      // Parse and preprocess data
      const parseYear = d3.timeParse("%Y");
      const renewableGrouped = d3.group(renewableEnergyData, d => d.Year);
      const renewableCleaned = Array.from(renewableGrouped, ([year, records]) => ({
        year: parseYear(year),
        energy: d3.sum(records, r => +r.TotalRenewableEnergy),
      }));

      const lifeGrouped = d3.group(lifeExpectancyData, d => d.Year);
      const lifeCleaned = Array.from(lifeGrouped, ([year, records]) => ({
        year: parseYear(year),
        lifeExpectancy: d3.mean(records, r => +r["Life Expectancy World Bank"]),
        co2: d3.mean(records, r => +r.CO2),
      }));

      const mergedData = renewableCleaned.map(d => {
        const match = lifeCleaned.find(ld => ld.year.getTime() === d.year.getTime());
        return {
          year: d.year,
          energy: d.energy,
          lifeExpectancy: match ? match.lifeExpectancy : null,
          co2: match ? match.co2 : null,
        };
      }).filter(d => d.lifeExpectancy !== null && d.co2 !== null);


      const width = 1600;
      const height = 700;
      const margins = { top: 60, right: 400, bottom: 60, left: 160 };
      const chartWidth = width - margins.left - margins.right;
      const chartHeight = height - margins.top - margins.bottom;

      // Scales
      const xScale = d3.scaleTime()
        .domain(d3.extent(mergedData, d => d.year))
        .range([0, chartWidth]);

      const yScaleEnergy = d3.scaleLinear()
        .domain([0, d3.max(mergedData, d => d.energy)])
        .range([chartHeight, 0]);

      const yScaleLife = d3.scaleLinear()
        .domain([d3.min(mergedData, d => d.lifeExpectancy), d3.max(mergedData, d => d.lifeExpectancy)])
        .range([chartHeight, 0]);

      const yScaleCO2 = d3.scaleLinear()
        .domain([0, d3.max(mergedData, d => d.co2)])
        .range([chartHeight, 0]);

      // SVG setup
      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const chartArea = svg.append("g")
        .attr("transform", `translate(${margins.left},${margins.top})`);

      // Gridlines
      chartArea.append("g")
        .attr("class", "gridlines-life")

      chartArea.append("g")
        .attr("class", "gridlines-co2")

      // Axes
      chartArea.append("g")
        .attr("class", "y-axis-life")
        .call(d3.axisLeft(yScaleLife).ticks(7).tickPadding(5))
        .selectAll("text")
        .style("font-size", "15px");


      chartArea.append("g")
        .attr("class", "y-axis-co2")
        .attr("transform", `translate(-40,0)`)
        .call(d3.axisLeft(yScaleCO2).ticks(6).tickPadding(5))
        .selectAll("text")
        .style("font-size", "15px");


      chartArea.append("g")
        .attr("class", "y-axis-energy")
        .attr("transform", `translate(${chartWidth},0)`)
        .call(d3.axisRight(yScaleEnergy).ticks(5).tickPadding(5))
        .style("font-size", "15px");


      chartArea.append("g")
        .attr("transform", `translate(0,${chartHeight})`)
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .style("font-size", "15px")
        .style("fill", "black");

      // Line generators
      const lineEnergy = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScaleEnergy(d.energy));

      const lineLife = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScaleLife(d.lifeExpectancy));

      const lineCO2 = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScaleCO2(d.co2));

      // Function to draw circles
      const drawCircles = (data, xScale, yScale, color, key) => {
        chartArea.selectAll(`circle.${key}`)
          .data(data)
          .enter()
          .append("circle")
          .attr("class", key)
          .attr("cx", d => xScale(d.year))
          .attr("cy", d => yScale(d[key]))
          .attr("r", 6)
          .attr("fill", color)
          .attr("opacity", 0.7); 

      };

      // Draw lines
      chartArea.append("path")
        .datum(mergedData)
        .attr("class", "line")
        .attr("d", lineEnergy)
        .attr("stroke", "#53C44F");

      chartArea.append("path")
        .datum(mergedData)
        .attr("class", "line")
        .attr("d", lineLife)
        .attr("stroke", "#5F9DD4");

      chartArea.append("path")
        .datum(mergedData)
        .attr("class", "line")
        .attr("d", lineCO2)
        .attr("stroke", "ED8D55");

      // Draw circles for each line
      drawCircles(mergedData, xScale, yScaleEnergy, "#53C44F", "energy");
      drawCircles(mergedData, xScale, yScaleLife, "#5F9DD4", "lifeExpectancy");
      drawCircles(mergedData, xScale, yScaleCO2, "#EC5042", "co2");

      const tooltip = d3.select("#tooltip");

      const drawLine = (data, lineGenerator, color, label) => {
        const lineGroup = chartArea.append("g");
        lineGroup.append("path")
          .datum(data)
          .attr("class", "line")
          .attr("d", lineGenerator)
          .attr("stroke", color)
          .style("cursor", "pointer")
          .on("mousemove", (event) => {
            const [x, y] = d3.pointer(event);
            const year = xScale.invert(x);
            const value = yScaleLife.invert(y);
            tooltip.style("display", "block")
              .style("left", `${event.pageX + 15}px`)
              .style("top", `${event.pageY - 15}px`)
              .html(`<b>${label}</b><br>Year: ${Math.round(year.getFullYear())}<br>Value: ${value.toFixed(2)}`);
          })
          .on("mouseout", () => tooltip.style("display", "none"));
      };

      drawLine(mergedData, lineEnergy, "#53C44F", "Renewable Energy");
      drawLine(mergedData, lineLife, "#5F9DD4", "Life Expectancy");
      drawLine(mergedData, lineCO2, "#EC5042", "CO2 Emissions");

      // Axis Labels
     
      svg.append("text")
        .attr("x", -chartHeight / 1.7) 
        .attr("y", margins.left / 5) 
        .attr("class", "axis-label")
        .attr("transform", "rotate(-90)") 
        .style("text-anchor", "middle") 
        .html(`
    <tspan fill="#5F9DD4">Life Expectancy (Yrs)  &nbsp; &nbsp; </tspan>
    <tspan fill="#EC5042">CO</tspan>
    <tspan fill="#EC5042" font-size="150%">₂</tspan>
    <tspan fill="#EC5042" dy="-0.2em"> Emissions (kT)</tspan>
  `);

      // Right Axis Label - Renewable Energy
      svg.append("text")
        .attr("x", 350) 
        .attr("y", -1290)
        .attr("class", "axis-label")
        .attr("transform", "rotate(90)")
        .style("fill", "#53C44F")
        .style("text-anchor", "middle") 
        .text("Renewable Energy (GWh)");


      svg.append("text")
        .attr("x", chartWidth / 1.55)
        .attr("y", height - 10)
        .attr("class", "axis-label")
        .text("Year")
        .style("text-anchor", "middle");

      // Legend
      const legend = svg.append("g")
        .attr("transform", `translate(${chartWidth + 250}, ${margins.top})`)
        .attr("class", "legend");

      legend.append("circle")
        .attr("cx", 0).attr("cy", 10).attr("r", 5).attr("fill", "#53C44F");
      legend.append("text")
        .attr("x", 15).attr("y", 14)
        .text("Total Annual Renewable Energy (GWh)");

      legend.append("circle")
        .attr("cx", 0).attr("cy", 30).attr("r", 5).attr("fill", "#5F9DD4");
      legend.append("text")
        .attr("x", 15).attr("y", 34)
        .text("Life Expectancy (Years)");

      legend.append("circle")
        .attr("cx", 0).attr("cy", 50).attr("r", 5).attr("fill", "#EC5042");
      legend.append("text")
        .attr("x", 15).attr("y", 54)
        .text("CO2 Emissions (kT)");
    };

    drawMultiLineChart();
  </script>
</body>

</html>