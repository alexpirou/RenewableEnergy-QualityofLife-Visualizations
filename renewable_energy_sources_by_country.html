<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stacked Bar Chart - Renewable Energy Souces by Country</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
    }
    .gridlines line {
      stroke: #bbb;
    }
    .gridlines .domain {
      stroke: none;
    }
    #button-bar {
      margin-top: 10px;
    }
    button {
      margin-right: 5px;
      padding: 5px 10px;
      font-size: 14px;
    }
    .tooltip {
      position: absolute;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Renewable Energy Sources by Country</h1>
  <div id="container">
    <svg id="barchart" height="600" width="900" style="background: #F5F5F5;"></svg>
  </div>
  
  <div id="button-bar"></div>

  <div id="tooltip" class="tooltip"></div>
  
<script>
    const svg = d3.select("svg#barchart");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = {top: 10, right: 10, bottom: 50, left: 50};
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    const annotations = svg.append("g").attr("id", "annotations");
    const chartArea = svg.append("g").attr("id", "points")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);
    
    const tooltip = d3.select("#tooltip");

    const color = d3.scaleOrdinal()
        .domain(["SolarEnergy", "WindEnergy", "HydroEnergy", "OtherRenewableEnergy"])
        .range(d3.schemeSpectral[4]);

    d3.csv('global_renewable_energy_production.csv').then(rawData => {
        rawData.forEach(d => {
        d.Year = +d.Year;
        d.SolarEnergy = +d.SolarEnergy;
        d.WindEnergy = +d.WindEnergy;
        d.HydroEnergy = +d.HydroEnergy;
        d.OtherRenewableEnergy = +d.OtherRenewableEnergy;
        });

        // Group data by year
        const yearData = d3.group(rawData, d => d.Year);

        //Scales
        const outputScale = d3.scaleLinear()
            .range([chartHeight, 0]);
        
        const countryScale = d3.scaleBand()
            .range([0, chartWidth])
            .padding(0.1);

        // Axises and gridlines
        let leftAxis = d3.axisLeft(outputScale).ticks(10);
        let leftGridlines = d3.axisLeft(outputScale)
                            .tickSize(-chartWidth-10)
                            .tickFormat("")
        annotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform",`translate(${margin.left - 10},${margin.top})`)
                    .call(leftGridlines);
        annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${margin.left},${margin.top})`)
                    .call(leftAxis);
        annotations.append("text")
                    .attr("class", "y-axis-label")
                    .attr("transform", `translate(${margin.left - 40}, ${margin.top + chartHeight / 2}) rotate(-90)`)
                    .style("text-anchor", "middle")
                    .style("font-size", "8px")
                    .style("fill", "#333")
                    .text("(Hundreds of Thousands of MWh)");
        let bottomAxis = d3.axisBottom(countryScale);
        annotations.append("g")
                    .attr("class", "x axis")
                    .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                    .call(bottomAxis);
        
        //update bars function
        function updateBarsAnimated(year) {
            const data = yearData.get(+year);
            const energyTypes = ["SolarEnergy", "WindEnergy", "HydroEnergy", "OtherRenewableEnergy"];
            const stackedData = d3.stack().keys(energyTypes)(data);

            // Update scales
            countryScale.domain(data.map(d => d.Country));
            outputScale.domain([0, d3.max(data, d => d.SolarEnergy + d.WindEnergy + d.HydroEnergy + d.OtherRenewableEnergy)]);

            // Update axes
            annotations.select(".y.axis")
                .transition()
                .call(leftAxis);

            annotations.select(".x.axis")
                .transition()
                .call(bottomAxis);

                chartArea.selectAll('g.layer')
                .data(stackedData)
                .join(
                    enter => enter.append('g')
                        .attr('class', 'layer')
                        .attr('fill', d => color(d.key)) 
                        .selectAll('rect')
                        .data(d => d)
                        .enter()
                        .append('rect')
                        .attr("x", d => countryScale(d.data.Country))
                        .attr("y", d => outputScale(d[1]))
                        .attr("height", d => outputScale(d[0]) - outputScale(d[1]))
                        .attr("width", countryScale.bandwidth())
                        .on("mouseover", (event, d) => {
                              const energyType = d3.select(event.target.parentNode).datum().key; 
                              tooltip.style("display", "block")
                                    .html(`
                                      <strong>${d.data.Country}</strong><br>
                                      ${energyType}: ${(d[1] - d[0]).toLocaleString()} MWh
                                    `);
                        })
                        .on("mousemove", event => {
                            tooltip.style("top", (event.pageY + 10) + "px")
                                   .style("left", (event.pageX + 10) + "px");
                        })
                        .on("mouseout", () => {
                            tooltip.style("display", "none");
                        }),
                    update => update.selectAll('rect')
                        .data(d => d)
                        .join(
                            enter => enter.append('rect')
                                .attr("x", d => countryScale(d.data.Country))
                                .attr("y", d => outputScale(d[1]))
                                .attr("height", d => outputScale(d[0]) - outputScale(d[1]))
                                .attr("width", countryScale.bandwidth())
                                .on("mouseover", (event, d) => {
                                    const energyType = d3.select(event.target.parentNode).datum().key; // Get the key (energy type) from the parent group
                                    tooltip.style("display", "block")
                                          .html(`
                                            <strong>${d.data.Country}</strong><br>
                                            ${energyType}: ${(d[1] - d[0]).toLocaleString()} MWh
                                          `);
                                })
                                .on("mousemove", event => {
                                    tooltip.style("top", (event.pageY + 10) + "px")
                                           .style("left", (event.pageX + 10) + "px");
                                })
                                .on("mouseout", () => {
                                    tooltip.style("display", "none");
                                }),
                            update => update.transition()
                                .attr("x", d => countryScale(d.data.Country))
                                .attr("y", d => outputScale(d[1]))
                                .attr("height", d => outputScale(d[0]) - outputScale(d[1]))
                                .attr("width", countryScale.bandwidth()),
                            exit => exit.transition().remove()
                        ),
                    exit => exit.transition().remove()
                );
        }

        // Add buttons
        const years = Array.from(yearData.keys()).sort((a, b) => a - b);
        const buttonBar = d3.select("#button-bar");
        years.forEach(year => {
        buttonBar.append("button")
            .text(year)
            .on("click", () => updateBarsAnimated(year));
        });

        // Add legend
        const legend = svg.append("g")
            .attr("id", "legend")
            .attr("transform", `translate(${chartWidth - 200}, ${margin.top})`);

        const energyTypes = ["Solar Energy", "Wind Energy", "Hydro Energy", "Other Renewable Energy"];

        legend.selectAll("g")
            .data(energyTypes)
            .join("g")
            .attr("class", "legend-item")
            .attr("transform", (d, i) => `translate(0, ${i * 20})`)
            .each(function (d) {
                const g = d3.select(this);
                g.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 10)
                    .attr("height", 10)
                    .attr("fill", color(d));
                g.append("text")
                    .attr("x", 25)
                    .attr("y", 14)
                    .text(d)
                    .style("font-size", "14px")
                    .style("fill", "#333");
            });

        // Initial year
        updateBarsAnimated(2023);
    });
</script>
</body>
</html>
